name: desktop-release

on:
  workflow_run:
    workflows: ["release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g. v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
      commit_sha: ${{ steps.commit_sha.outputs.commit_sha }}
      upload_url: ${{ steps.upload_url.outputs.upload_url }}
    steps:
      - name: Get Commit SHA
        id: commit_sha
        uses: actions/github-script@v7
        with:
          script: |
            let sha;
            if (context.eventName === 'workflow_dispatch') {
              // For manual triggers, get the commit SHA for the specified tag
              try {
                const { data: ref } = await github.rest.git.getRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${context.payload.inputs.tag}`
                });
                
                if (ref.object.type === 'tag') {
                  // If the tag is an annotated tag, we need to fetch the commit ID from the tag's object
                  const { data: tagObject } = await github.rest.git.getTag({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    tag_sha: ref.object.sha
                  });
                  sha = tagObject.object.sha; // The sha of the commit the annotated tag points to
                } else {
                  sha = ref.object.sha; // Direct commit SHA for lightweight tag
                }
                
              } catch (error) {
                throw new Error(`Failed to get commit SHA for tag ${context.payload.inputs.tag}: ${error.message}`);
              }
            } else {
              // For workflow_run triggers, use the commit SHA from the workflow_run event
              sha = context.payload.workflow_run.head_sha;
            }

            console.log(`Commit SHA: ${sha}`);
            core.setOutput('commit_sha', sha);

      - name: Get Tag
        id: tag
        uses: actions/github-script@v7
        with:
          script: |
            let tag;
            if (context.eventName === 'workflow_dispatch') {
              tag = context.payload.inputs.tag;
            } else {
              // Get the tag from the workflow_run event
              tag = context.payload.workflow_run.head_branch;
            }
            console.log(`Tag: ${tag}`);
            core.setOutput('tag', tag);

      - name: Get Upload URL
        id: upload_url
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: '${{ steps.version.outputs.tag }}',
            });
            console.log(`Upload URL: ${release.upload_url}`);
            core.setOutput('upload_url', release.upload_url);

  build:
    needs: prepare
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: darwin
            build_os: macos-latest
            arch: amd64
            suffix: _amd64
            display_os: macOS
          - os: darwin
            build_os: macos-latest
            arch: arm64
            suffix: _arm64
            display_os: macOS
          - os: windows          
            build_os: windows-latest
            arch: amd64
            suffix: .exe
            display_os: Windows
          - os: windows
            build_os: windows-11-arm
            arch: arm64
            suffix: _arm64.exe
            display_os: Windows
    runs-on: ${{ matrix.build_os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.commit_sha }}
            
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Install MSYS2 (Windows ARM64)
        if: matrix.os == 'windows' && matrix.arch == 'arm64'
        uses: msys2/setup-msys2@v2
        with:
          msystem: mingw64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-gcc-aarch64-w64-mingw32
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-pkgconf

      - name: Build Windows ARM64
        if: matrix.os == 'windows' && matrix.arch == 'arm64'
        env:
          CGO_ENABLED: 1
          GOARCH: arm64
          CC: clang
          CXX: clang++
          CGO_CFLAGS: -target aarch64-w64-mingw32
          CGO_LDFLAGS: -target aarch64-w64-mingw32
        run: |
          $env:Path = "C:\msys64\mingw64\bin;$env:Path"
          go build -o KrillinAI_Desktop_arm64.exe ./cmd/desktop
        shell: pwsh

      - name: Build Others
        if: matrix.os != 'windows' || matrix.arch != 'arm64'
        env:
          CGO_ENABLED: 1
          GOARCH: ${{ matrix.arch }}
        run: |
          go build -o KrillinAI_Desktop${{ matrix.suffix }} ./cmd/desktop

      - name: Upload Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.prepare.outputs.upload_url }}
          asset_path: KrillinAI_Desktop${{ matrix.suffix }}
          asset_name: KrillinAI_Desktop_${{ needs.prepare.outputs.tag }}_${{ matrix.display_os }}${{ matrix.suffix }}
          asset_content_type: application/octet-stream
